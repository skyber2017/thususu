<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Home</title>
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/jquery/css/jquery-ui.min.css">
	<script src="/static/jquery-3.2.1.min.js" type="text/javascript"></script>
	<link rel="stylesheet" href="/static/bootstrap/css/tether.min.css">
	<script src="/static/bootstrap/js/tether.min.js"></script>
	<script src="/static/jquery/js/jquery-ui.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="/static/home/css/home.css">
	<script src="/static/home/js/home.js" type="text/javascript"></script>
	<link rel="stylesheet" href="/static/font/css/font-awesome.min.css">
	<link rel="stylesheet" href="/static/sweetalert.min.css">
	
	<script src="/static/moment.min.js"></script>
	<script src="/static/moment-locales.min.js"></script>
	<script src="/static/jquery/js/sweetalert.all.min.js"></script>
	
</head>
<body>
	<nav class="navbar navbar-toggleable-md navbar-inverse  bg-inverse">
	  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
	    <span class="navbar-toggler-icon"></span>
	  </button>
	  <a class="navbar-brand" href="/">Trang chủ</a>

	  <div class="collapse navbar-collapse" id="navbarSupportedContent" >
	    <ul class="navbar-nav mr-auto">
	      <li class="nav-item active">
	        <a class="nav-link" href="#">Gửi báo cáo <span class="sr-only">(current)</span></a>
	      </li>
	      <li class="nav-item">
	        <a class="nav-link" href="#">Liên hệ</a>
	      </li>
	      
	    </ul>
	    <form class="form-inline my-2 my-lg-0">
	    {% if session.get('user') %}

	      	<a href="/logout" class="btn btn-primary">Đăng xuất</a>
	    {% else %}
	    	<a href="/login" class="btn btn-primary">Đăng nhập</a>
	    {% endif %}
	    </form>
	  </div>
	</nav>

	<content style="height: 100%">
		<section>
		  <!--for demo wrap-->
		  <div>
		  	<button class="btn btn-primary float-right btnAdd" onclick="add('{{ session.user }}');">
		  		<i class="fa fa-plus"> THÊM MỚI</i>
		  	</button>
		  	<h1 id="time_now">
		  	
			  </h1>
			  
		  </div>
		  <script>
		  	moment.locale('vi');
		  	function update() {
		  		moment.locale('vi');				
				var time = moment().format("LLLL");
				var res = time.replace(moment().format('LT'),"");
				$('#time_now').html(res+moment().format('LTS'));
				
			}

			setInterval(update, 1000);
		  </script>
		  <div class="tbl-header">
		    <table cellpadding="0" cellspacing="0" border="0">
		      <thead>
		        <tr>
		          <th style="width: 20px;">#</th>
		          <th>TIÊU ĐỀ</th>
		          <th>NGÀY KHỞI TẠO</th>
		          <th>DEADLINE</th>
		          <th>SỬA LẦN CUỐI</th>
		          <th class="text-center">TÁC VỤ</th>
		        </tr>
		      </thead>
		    </table>
		  </div>
		  <div class="tbl-content">
		    <table cellpadding="0" cellspacing="0" border="0">
		      <tbody>
		      	
		      	{%for i in data%}
				
		        <tr>
		          <td style="width: 20px;">{{i[0]}}</td>
		          <td>
		          	<button class="btn btn-link" onclick="info({{i[0]}});">{{i[5]}}</button>
		          </td>
		          <td id="timeInit{{i[0]}}"></td>
		        	<script>
		        		document.getElementById("timeInit{{i[0]}}").innerHTML = moment('{{i[2]}}').format('DD/MM/YYYY h:mm:ss');
		        	</script>
		          <td id="timeDeadline{{i[0]}}"></td>
		          <script>
		          	document.getElementById("timeDeadline{{i[0]}}").innerHTML = moment('{{i[3]}}').format('DD/MM/YYYY');
		          </script>
		          <td id="timeLast{{i[0]}}"></td>
		          <script>
		          	document.getElementById("timeLast{{i[0]}}").innerHTML = moment('{{i[4]}}').format('DD/MM/YYYY h:mm:ss');
		          </script>
		          <td class="text-center">
		          	<button class="btn btn-success" onclick="edit(1);" >
		          		<i class="fa fa-pencil-square-o fa-xs" aria-hidden="true"></i>
		          	</button>
		          	<button class="btn btn-success"  onclick="del(1);">
		          		<i class="fa fa-trash"></i>
		          	</button>
		          	<button class="btn btn-primary" onclick="done(1);">
		          		<i class="fa fa-check-square-o" aria-hidden="true"></i>
		          	</button>
		          </td>
		        </tr>
		        {% endfor%}
		      </tbody>
		    </table>
		  </div>
		</section>


		<!-- follow me template -->
		<div class="made-with-love">
		  Made with
		  <i>♥</i> by
		  <a target="_blank" href="https://codepen.io/nikhil8krishnan">Nikhil Krishnan</a>
		</div>
	</content>
	
</div>
	<script>
		function done(id){
			swal({
			  title: 'Bạn đã hoàn thành công việc!',
			  text: "",
			  type: 'question',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'HOÀN THÀNH',
			  cancelButtonText:'Hủy bỏ',
			  focusConfirm: false
			}).then(function () {
			  swal(
			    'RẤT TỐT!',
			    'Xin chúc mừng bạn đã hoàn thành công việc!',
			    'success'
			  )
			})
		}
		function del(id) {
		  	swal({
			  title: 'Bạn có muốn xóa?',
			  text: "Sau khi xóa thì không thể hoàn tác!",
			  type: 'question',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Xác định xóa!',
			  cancelButtonText:'Hủy bỏ',
			  showLoaderOnConfirm: true
			}).then(function () {
			  swal(
			    'Xóa thành công!',
			    '',
			    'success'
			  )
			})
		  };

		function info(id){
			swal({
			  title: 'Đang tải dữ liệu!',
			  text: 'Xin chờ chút!',	  
			  timer: 1000,
			  onOpen: function () {
			    swal.showLoading()
			  }
			}).then(function (result) {
			  if (result.dismiss === 'timer') {
			    $.ajax({
					url: '/info',
					type: 'POST',				
					data: {
						id:id,
						user: '{{session.get["user"]}}'
					}
					
				})
				.done(function(data) {
					if(data.status == 0){
						swal(data.content)
					}
					else{
						swal({
							title:"Đã có lỗi xảy ra",
							text: data.message,
							type:"error"
						})
					}
				})
				.fail(function() {
					swal({
						title:"Lỗi không xác định!",
						text: "Hãy thông báo với Admin nhé!",
						type: "error"
					})
				});
			  }
			})
			
			
			
		}

		function edit(id){
			swal({
			  title: 'Chỉnh sửa thông tin',
			  html:
			    '<input id="swal-input2" class="swal2-input" placeholder="Tiêu đề">'+
			    '<div class="container"><div ><div class="form-group"><div class="input-group date" id="datetimepicker11"><input type="text" class="form-control" /><span class="input-group-addon"><span class="fa fa-calendar"></span></span></div></div></div></div>'+
			    '<textarea class="form-control" rows="7" placeholder="Nội dung"></textarea>',
			  focusConfirm: false,
			  preConfirm: function () {
			    return new Promise(function (resolve) {
			      resolve([
			        $('#swal-input1').val(),
			        $('#swal-input2').val()
			      ])
			    })
			  }
			}).then(function (result) {
			  swal(JSON.stringify(result))
			}).catch(swal.noop)
		}

		

		function add(user){
			swal({
				  title: "Thêm mới!",
				  html: '<input style="margin-bottom:20px;" type="text" class="form-control" placeholder="Tiêu đề" id="title">'+
				  		'<input type="text" style="margin-bottom:20px;" class="form-control deadline" placeholder="Deadline" id="datepicker" >'+
				  		'<textarea class="form-control" style="margin-bottom:20px;" rows="9" placeholder="Nội dung" id="content"></textarea>',				  
				  showCancelButton: true,
				  confirmButtonColor: "#DD6B55",
				  confirmButtonText: "Xác nhận",
				  cancelButtonText: "Hủy bỏ",
				  
				  showLoaderOnConfirm: true,
				  focusConfirm:false,
				  onOpen:function(){
				  	$('#datepicker').datepicker({dateFormat: 'yy-mm-dd'});

				  },
				  preConfirm: function () {
				    return new Promise(function (resolve) {
				      $.ajax({
				      	url: '/add',
				      	type: 'POST',
				      	contentType: 'application/json;charset=UTF-8',
				      	data: JSON.stringify({
				      		user:user,
				      		title:$('#title').val(),
				      		content:$('#content').val(),
				      		deadline:$('.deadline').val()
				      	}),
				      	success: function(data){
				      		resolve(data);
				      	},
				      	error:function(){
				      		swal({
				  				title : "Đã có lỗi xảy ra!",
				  				text : "Lỗi không xác định. Vui lòng liên hệ Admin",
				  				type : "error",
				  			})
				      	}
				      })
				     })
				  }}).then(function (data) {
					if(data.status == 0){
						//var message = data.message;
						swal({
				  				title : "THÀNH CÔNG!",
				  				text : data.message,
				  				type : "success"
				  			}).then(function(){
					  			window.location.reload();
					  		})
				  	}
				  	else{
				  		swal({
				  			title : "CÓ LỖI XẢY RA RỒI!",
				  			text : data.message,
				  			type : "error",
				  		})
				  	}
				})
		}
	</script>
	
</body>
</html>
